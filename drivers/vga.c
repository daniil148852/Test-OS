#include "drivers/vga.h"
#include "drivers/ports.h"
#include "lib/string.h"

static uint8_t* VGA = (uint8_t*)0xA0000;
static uint8_t backbuffer[VGA_WIDTH * VGA_HEIGHT];

// 8x8 bitmap font (simplified)
static const uint8_t font[128][8] = {
    [' '] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['!'] = {0x18,0x18,0x18,0x18,0x00,0x00,0x18,0x00},
    ['"'] = {0x6C,0x6C,0x00,0x00,0x00,0x00,0x00,0x00},
    ['#'] = {0x6C,0xFE,0x6C,0x6C,0xFE,0x6C,0x00,0x00},
    ['$'] = {0x18,0x7E,0x58,0x7C,0x1A,0x7C,0x18,0x00},
    ['%'] = {0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00},
    ['&'] = {0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00},
    ['('] = {0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00},
    [')'] = {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00},
    ['*'] = {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00},
    ['+'] = {0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00},
    [','] = {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30},
    ['-'] = {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00},
    ['.'] = {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00},
    ['/'] = {0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00},
    ['0'] = {0x7C,0xC6,0xCE,0xD6,0xE6,0xC6,0x7C,0x00},
    ['1'] = {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00},
    ['2'] = {0x7C,0xC6,0x06,0x1C,0x30,0x66,0xFE,0x00},
    ['3'] = {0x7C,0xC6,0x06,0x3C,0x06,0xC6,0x7C,0x00},
    ['4'] = {0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x1E,0x00},
    ['5'] = {0xFE,0xC0,0xC0,0xFC,0x06,0xC6,0x7C,0x00},
    ['6'] = {0x38,0x60,0xC0,0xFC,0xC6,0xC6,0x7C,0x00},
    ['7'] = {0xFE,0xC6,0x0C,0x18,0x30,0x30,0x30,0x00},
    ['8'] = {0x7C,0xC6,0xC6,0x7C,0xC6,0xC6,0x7C,0x00},
    ['9'] = {0x7C,0xC6,0xC6,0x7E,0x06,0x0C,0x78,0x00},
    [':'] = {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00},
    [';'] = {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x30},
    ['<'] = {0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00},
    ['='] = {0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00},
    ['>'] = {0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00},
    ['?'] = {0x7C,0xC6,0x0C,0x18,0x18,0x00,0x18,0x00},
    ['@'] = {0x7C,0xC6,0xDE,0xDE,0xDE,0xC0,0x78,0x00},
    ['A'] = {0x38,0x6C,0xC6,0xFE,0xC6,0xC6,0xC6,0x00},
    ['B'] = {0xFC,0x66,0x66,0x7C,0x66,0x66,0xFC,0x00},
    ['C'] = {0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00},
    ['D'] = {0xF8,0x6C,0x66,0x66,0x66,0x6C,0xF8,0x00},
    ['E'] = {0xFE,0x62,0x68,0x78,0x68,0x62,0xFE,0x00},
    ['F'] = {0xFE,0x62,0x68,0x78,0x68,0x60,0xF0,0x00},
    ['G'] = {0x3C,0x66,0xC0,0xC0,0xCE,0x66,0x3A,0x00},
    ['H'] = {0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0x00},
    ['I'] = {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    ['J'] = {0x1E,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0x00},
    ['K'] = {0xE6,0x66,0x6C,0x78,0x6C,0x66,0xE6,0x00},
    ['L'] = {0xF0,0x60,0x60,0x60,0x62,0x66,0xFE,0x00},
    ['M'] = {0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0x00},
    ['N'] = {0xC6,0xE6,0xF6,0xDE,0xCE,0xC6,0xC6,0x00},
    ['O'] = {0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00},
    ['P'] = {0xFC,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00},
    ['Q'] = {0x7C,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x06},
    ['R'] = {0xFC,0x66,0x66,0x7C,0x6C,0x66,0xE6,0x00},
    ['S'] = {0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00},
    ['T'] = {0x7E,0x7E,0x5A,0x18,0x18,0x18,0x3C,0x00},
    ['U'] = {0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00},
    ['V'] = {0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x00},
    ['W'] = {0xC6,0xC6,0xC6,0xD6,0xD6,0xFE,0x6C,0x00},
    ['X'] = {0xC6,0xC6,0x6C,0x38,0x6C,0xC6,0xC6,0x00},
    ['Y'] = {0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0x00},
    ['Z'] = {0xFE,0xC6,0x8C,0x18,0x32,0x66,0xFE,0x00},
    ['['] = {0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00},
    [']'] = {0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00},
    ['a'] = {0x00,0x00,0x78,0x0C,0x7C,0xCC,0x76,0x00},
    ['b'] = {0xE0,0x60,0x7C,0x66,0x66,0x66,0xDC,0x00},
    ['c'] = {0x00,0x00,0x7C,0xC6,0xC0,0xC6,0x7C,0x00},
    ['d'] = {0x1C,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00},
    ['e'] = {0x00,0x00,0x7C,0xC6,0xFE,0xC0,0x7C,0x00},
    ['f'] = {0x3C,0x66,0x60,0xF8,0x60,0x60,0xF0,0x00},
    ['g'] = {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0xF8},
    ['h'] = {0xE0,0x60,0x6C,0x76,0x66,0x66,0xE6,0x00},
    ['i'] = {0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00},
    ['j'] = {0x06,0x00,0x06,0x06,0x06,0x66,0x66,0x3C},
    ['k'] = {0xE0,0x60,0x66,0x6C,0x78,0x6C,0xE6,0x00},
    ['l'] = {0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    ['m'] = {0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0x00},
    ['n'] = {0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x00},
    ['o'] = {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0x00},
    ['p'] = {0x00,0x00,0xDC,0x66,0x66,0x7C,0x60,0xF0},
    ['q'] = {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0x1E},
    ['r'] = {0x00,0x00,0xDC,0x76,0x60,0x60,0xF0,0x00},
    ['s'] = {0x00,0x00,0x7E,0xC0,0x7C,0x06,0xFC,0x00},
    ['t'] = {0x30,0x30,0xFC,0x30,0x30,0x36,0x1C,0x00},
    ['u'] = {0x00,0x00,0xCC,0xCC,0xCC,0xCC,0x76,0x00},
    ['v'] = {0x00,0x00,0xC6,0xC6,0xC6,0x6C,0x38,0x00},
    ['w'] = {0x00,0x00,0xC6,0xD6,0xD6,0xFE,0x6C,0x00},
    ['x'] = {0x00,0x00,0xC6,0x6C,0x38,0x6C,0xC6,0x00},
    ['y'] = {0x00,0x00,0xC6,0xC6,0xC6,0x7E,0x06,0xFC},
    ['z'] = {0x00,0x00,0xFE,0x8C,0x18,0x32,0xFE,0x00},
    ['_'] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
};

void vga_init(void) {
    // Set mode 13h (320x200, 256 colors)
    __asm__ volatile(
        "mov $0x13, %%ax\n"
        "int $0x10\n"
        : : : "ax"
    );
    memset(backbuffer, 0, sizeof(backbuffer));
}

void vga_putpixel(int x, int y, uint8_t color) {
    if (x >= 0 && x < VGA_WIDTH && y >= 0 && y < VGA_HEIGHT) {
        backbuffer[y * VGA_WIDTH + x] = color;
    }
}

void vga_clear(uint8_t color) {
    memset(backbuffer, color, sizeof(backbuffer));
}

void vga_fillrect(int x, int y, int w, int h, uint8_t color) {
    for (int j = y; j < y + h; j++) {
        for (int i = x; i < x + w; i++) {
            vga_putpixel(i, j, color);
        }
    }
}

void vga_rect(int x, int y, int w, int h, uint8_t color) {
    for (int i = x; i < x + w; i++) {
        vga_putpixel(i, y, color);
        vga_putpixel(i, y + h - 1, color);
    }
    for (int j = y; j < y + h; j++) {
        vga_putpixel(x, j, color);
        vga_putpixel(x + w - 1, j, color);
    }
}

void vga_putchar(int x, int y, char c, uint8_t color) {
    if (c < 0 || c > 127) return;
    const uint8_t* glyph = font[(int)c];
    for (int j = 0; j < 8; j++) {
        for (int i = 0; i < 8; i++) {
            if (glyph[j] & (0x80 >> i)) {
                vga_putpixel(x + i, y + j, color);
            }
        }
    }
}

void vga_print(int x, int y, const char* str, uint8_t color) {
    int ox = x;
    while (*str) {
        if (*str == '\n') {
            x = ox;
            y += 10;
        } else {
            vga_putchar(x, y, *str, color);
            x += 8;
        }
        str++;
    }
}

void vga_swap(void) {
    memcpy(VGA, backbuffer, sizeof(backbuffer));
}
